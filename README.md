# Django_You_stone
python you_stone/manage.py runserver
python you_stone/manage.py makemigrations
python you_stone/manage.py migrate
python you_stone/manage.py createsuperuser admin:admin
Необходимо написать приложение для работы с видео: можно получать видео, ставить им лайки и выводить статистику по лайкам пользователей. Акцент на REST API и DRF.

### Какие есть сущности?

**Видео:**

```Python
owner
is_published
name
total_likes
created_at
```


Видео принадлежит пользователю (владельцу), имеет название, дату создания и флаг "опубликовано" - API отдаёт только опубликованные ролики, либо видео владельца, если запрос делает владелец видео. Хотя сами лайки - это отдельная сущность, мы делаем денормальзацию чтобы поработать с гонками

**Видео-файл/медиа-файла:**

```Python
video
file
quality (HD, FHD, UHD)
```


Видео-файл (например, file.mp4) привязан к видео и содержит файл (FileField) с указанием качества: HD (720p), FHD (1080p) или UHD (4K). Одно видео может включать несколько видео-файлов с разным качеством.

**Лайк:**

```Python
video
user
```


Лайки могут ставить только авторизованные пользователи. Каждый лайк содержит ссылки на видео и пользователя, при этом один пользователь может поставить только один лайк на видео (уникальная пара user-video).

### Какие нужны ручки?

Требуется всего 6 ручек: получения конкретного видео по ID, списка видео (должна быть пагинация), списка идентификаторов опубликованных видео, добавления/удаления лайка (с ограничением - один пользователь может поставить только один лайк на видео), а также получения статистики по видео в двух вариантах.

```Python
"/v1/videos/{video.id}/"
"/v1/videos/"
"/v1/videos/{video.id}/likes/"
"/v1/videos/ids/"
"/v1/videos/statistics-subquery/"
"/v1/videos/statistics-group-by/"
```


- ручки для получения видео возвращают username владельца, название видео, количество лайков, дату создания и список всех видеофайлов с указанием их качества (HD, FHD, UHD):

  - неавторизованных пользователей могут просматривать только опубликованные видео

  - авторизованные пользователи могут просматривать все опубликованные видео, а также свои собственные (включая неопубликованные)

  - служебные пользователи (флаг is_staff в модели пользователя) могут просматривать все видео без ограничений

- ручка для работы с лайками реализует добавление/удаление лайка для опубликованных видео и поддерживает обработку конкурентных запросов, обеспечивает уникальность (1 пользователь = 1 лайк на видео), корректно обрабатывает дублирующиеся запросы

- ручка для получения идентификаторов (ID) доступна только служебным пользователям и возвращает список c идентификаторами всех опубликованных видео, все видео за один раз, без пагинации

- ручки ****статистики доступны только служебным пользователям и возвращают список пользователей с количеством их лайков, реализованный двумя способами агрегации: через подзапрос (subquery) и через группировку (group by), делаем пару вариантов для тренировки, ниже примеры sql запросов которые сгенерирует ORM, делать один в один не нужно, главное чтобы в одном был подзапросов, а в другом не было

```Python
SELECT 
  "users_appuser"."username" AS "username", 
  (
    SELECT 
      SUM(U0."total_likes") AS "likes_sum" 
    FROM 
      "videos_video" U0 
    WHERE 
      (
        U0."is_published" 
        AND U0."owner_id" = ("users_appuser"."id")
      ) 
    GROUP BY 
      U0."owner_id"
  ) AS "likes_sum" 
FROM 
  "users_appuser" 
ORDER BY 
  2 DESC
```


```Python
SELECT 
  "users_appuser"."username" AS "username", 
  SUM("videos_video"."total_likes") AS "likes_sum" 
FROM 
  "videos_video" 
  INNER JOIN "users_appuser" ON (
    "videos_video"."owner_id" = "users_appuser"."id"
  ) 
WHERE 
  "videos_video"."is_published" 
GROUP BY 
  1 
ORDER BY 
  2 DESC

```


### Что ещё нужно сделать кроме ручек?

- предоставить возможность контент-администраторам добавлять и редактировать видео через админ-панель

- написать Dockerfile приложения, можно без многоэтапной сборки

- собрать структуру проекта с использованием лучших практик

- подключить в настройках, только для режима разработки, вывод всех SQL-запросов, поможет разобраться с ORM

- создать 100к опубликованных видео для 10к пользователей, поможет разобраться с ORM

- посмотреть какие SQL запросы генерирует: all, filter, exclude, save, defer, only, values, values_list, select_related, prefetch_related, select_for_update, get_or_create, count, exists

### Какую базу использовать?

Используем PostgreSQL.

### Если я всё сделал, можно ли где-то посмотреть пример решения?

Да, пример решение доступен в [репозитории](https://github.com/eumozge/django-section).

### Нужно ли писать тесты?

На своё усмотрение, можно не писать, по тестам есть отдельный блок, но в любом случае стоит посмотреть, как готовить тесты для Django-проекта – в примере решения тесты написаны.

### Сколько времени примерно закладывать на практику?

Закладывай от 4 до 8 часов.
